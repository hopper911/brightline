generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
}

model PortfolioProject {
  id           String   @id @default(cuid())
  title        String
  slug         String   @unique
  category     String
  categorySlug String
  categoryId   String?
  location     String?
  year         String?
  description  String?
  coverUrl     String?
  coverAlt     String?
  seoTitle     String?
  seoDescription String?
  ogImageUrl   String?
  externalGalleryUrl String?
  published    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  categoryRef  PortfolioCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images       PortfolioImage[]
}

model ClientGalleryAccess {
  id          String   @id @default(cuid())
  clientName  String
  projectName String
  accessCode  String   @unique
  galleryUrl  String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PortfolioCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  PortfolioProject[]
}

model PortfolioImage {
  id        String   @id @default(cuid())
  projectId String
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  project   PortfolioProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, sortOrder])
}

model Client {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  company   String?
  website   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
  galleries Gallery[]
}

model Project {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  category    String?
  location    String?
  year        String?
  coverUrl    String?
  featured    Boolean  @default(false)
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  clientId    String?

  client      Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  images      ProjectImage[]
  tags        ProjectTag[]
  testimonials Testimonial[]
  galleries   Gallery[]
}

model ProjectImage {
  id        String   @id @default(cuid())
  projectId String
  url       String
  alt       String?
  storageKey String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, sortOrder])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  projects  ProjectTag[]
}

model ProjectTag {
  id        String   @id @default(cuid())
  projectId String
  tagId     String
  createdAt DateTime @default(now())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([projectId, tagId])
  @@index([tagId])
}

model Testimonial {
  id        String   @id @default(cuid())
  name      String
  role      String?
  company   String?
  quote     String
  projectId String?
  published Boolean  @default(true)
  createdAt DateTime @default(now())

  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
}

model Lead {
  id                String   @id @default(cuid())
  type              String   @default("inquiry")
  status            String   @default("new")
  score             Int      @default(0)
  name              String?
  email             String
  phone             String?
  company           String?
  service           String?
  budget            String?
  message           String?
  availabilityStart DateTime?
  availabilityEnd   DateTime?
  location          String?
  shootType         String?
  source            String?
  internalNotes     String?
  contactedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Gallery {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  coverUrl    String?
  clientNotes String?  // notes visible to client in gallery view
  internalNotes String? // admin-only notes
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  clientId    String?
  projectId   String?

  client      Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  images      GalleryImage[]
  accessTokens GalleryAccessToken[]
}

model GalleryImage {
  id        String   @id @default(cuid())
  galleryId String
  url       String
  alt       String?
  storageKey String?
  filename  String?  // original filename for downloads
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  gallery   Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  favorites GalleryFavorite[]

  @@index([galleryId, sortOrder])
}

model GalleryAccessToken {
  id        String   @id @default(cuid())
  galleryId String
  token     String   @unique
  label     String?  // e.g., "Marketing Team", "Client Review"
  expiresAt DateTime?
  allowDownload Boolean @default(true)
  maxDownloads  Int?    // null = unlimited
  createdAt DateTime @default(now())

  gallery   Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  accessLogs GalleryAccessLog[]
  favorites  GalleryFavorite[]
  downloads  GalleryDownload[]
  
  @@index([galleryId])
}

model GalleryAccessLog {
  id        String   @id @default(cuid())
  tokenId   String
  action    String   // "view", "download", "favorite", "unfavorite"
  imageId   String?  // null for gallery-level actions
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  token     GalleryAccessToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  
  @@index([tokenId])
  @@index([createdAt])
}

model GalleryFavorite {
  id        String   @id @default(cuid())
  tokenId   String
  imageId   String
  note      String?  // client can add notes to favorites
  createdAt DateTime @default(now())

  token     GalleryAccessToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  image     GalleryImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  @@unique([tokenId, imageId])
  @@index([tokenId])
}

model GalleryDownload {
  id        String   @id @default(cuid())
  tokenId   String
  imageId   String?  // null for bulk download
  type      String   @default("single") // "single", "bulk", "favorites"
  createdAt DateTime @default(now())

  token     GalleryAccessToken @relation(fields: [tokenId], references: [id], onDelete: Cascade)
  
  @@index([tokenId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
